name: Deploy to Server

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: esp_secrets

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo -e "Host *\n  StrictHostKeyChecking no\n  IdentityFile ~/.ssh/id_ed25519\n" > ~/.ssh/config
          
      - name: Setup Git SSH Key on server
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
              mkdir -p ~/.ssh &&
              echo '${{ secrets.GIT_DEPLOY_KEY }}' > ~/.ssh/id_git &&
              chmod 600 ~/.ssh/id_git &&
              printf 'Host github.com\n  IdentityFile ~/.ssh/id_git\n  StrictHostKeyChecking no\n' >> ~/.ssh/config
            "
      - name: Prepare project dir on server
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            echo 'üìÇ –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é /srv/esp_system'
            sudo mkdir -p /srv/esp_system
            sudo chown -R ${{ secrets.SSH_USER }}:${{ secrets.SSH_USER }} /srv/esp_system
            sudo chmod -R 755 /srv/esp_system
          "
          
      - name: Clone Repo if not exists
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} '
            if ! command -v git &> /dev/null; then
              echo "üì¶ Git –Ω–µ –Ω–∞–π–¥–µ–Ω, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é..."
              if [ -f /etc/debian_version ]; then
                sudo apt update && sudo apt install -y git
              elif [ -f /etc/redhat-release ]; then
                sudo yum install -y git
              else
                echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –û–°, git –Ω—É–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å —Ä—É–∫–∞–º–∏" && exit 1
              fi
            fi
      
            if [ ! -d /srv/esp_system/.git ]; then
              git clone git@github.com:sauvingnon/smart_home.git /srv/esp_system
            fi
          '
      - name: Create env files on server
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
              echo '${{ secrets.ESP_TG_BOT_ENV_FILE }}' > /srv/esp_system/esp_tg_bot/.env &&
              echo '${{ secrets.ESP_SERVICE_ENV_FILE }}' > /srv/esp_system/esp_service/.env &&
              echo '${{ secrets.MQTT_BROKER_ENV_FILE }}' > /srv/esp_system/mosquitto/config/.env
            "
      - name: Deploy over SSH
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} '
            cd /srv/esp_system &&
            git fetch origin master &&
            git reset --hard origin/master &&
            cd /srv/esp_system &&
            sudo docker compose down &&
            sudo docker compose up -d --build
          '
      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
        run: |
          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} '
            echo "üîç –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:"
            sudo docker ps
            echo ""
            echo "üö® –ü—Ä–æ–≤–µ—Ä–∫–∞: –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã running?"
            FAIL=0
            for c in esp_grafana esp_promtail esp_redis esp_loki mosquitto esp_tg_bot esp_service esp_front; do
              STATUS=$(sudo docker inspect -f "{{.State.Status}}" ${c} || echo "missing")
              echo "$c -> $STATUS"
              if [ "$STATUS" != "running" ]; then
                echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä $c –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
                FAIL=1
              fi
            done
            exit $FAIL
          '
